IF (NOT VCPKG_CMAKE_SYSTEM_NAME OR NOT VCPKG_CMAKE_SYSTEM_NAME STREQUAL "Linux")
    MESSAGE(FATAL_ERROR "Intel spdk currently only supports Linux/BSD platforms")
ENDIF ()

VCPKG_FROM_GITHUB(
    OUT_SOURCE_PATH SOURCE_PATH
    REPO spdk/spdk
    REF "v${VERSION}"
    SHA512 c683136593661fddae6e849a1496e6664ad74e89661f6ec6ad82e653d8fc5bb64496d5d9fb263c1a05c868c1ecd1cc869d48c52895423aebab5df7a161197199
    HEAD_REF master
)

VCPKG_FROM_GITHUB(
    OUT_SOURCE_PATH SPDK_ISAL_SOURCE_PATH
    REPO spdk/isa-l
    REF 6f420b14a1e3e091bc9d15f508a54f82c007483c
    SHA512 07c64332fe279605732e2360e97fa622ffc5cf40763e3e482e7193f68f4c8ace38e3b5c14ef5d542ee86515bd7f610ed218745e6b8ae1c24c894cacd6a7d6325
    HEAD_REF master
)

file(REMOVE_RECURSE "${SOURCE_PATH}/isa-l")
file(COPY "${SPDK_ISAL_SOURCE_PATH}/" DESTINATION "${SOURCE_PATH}/isa-l")

VCPKG_FROM_GITHUB(
    OUT_SOURCE_PATH SPDK_ISAL_CRYPTO_SOURCE_PATH
    REPO intel/isa-l_crypto
    REF 9b7a2b842c9f4e54b8dc1c82899e5a5520c53301
    SHA512 9d8895e092604776ac1d6d961670e43a882a2fbdad9b75c8312157e12ed0cc2feb1a6a0525839d1a927a168a49cf04b0944692e327cd3c03bf1d9f99c924e342
    HEAD_REF master
)

file(REMOVE_RECURSE "${SOURCE_PATH}/isa-l-crypto")
file(COPY "${SPDK_ISAL_CRYPTO_SOURCE_PATH}/" DESTINATION "${SOURCE_PATH}/isa-l-crypto")

VCPKG_FROM_GITHUB(
    OUT_SOURCE_PATH SPDK_DPDK_SOURCE_PATH
    REPO spdk/dpdk
    REF 821c2fed1625304101d786ca13f976ed185f10ef
    SHA512 0c7dbd875462e2a00404bf5fdad32cc3f4d23ce29885a19613e73575e557bac5ceb0c8d2be70fe3340d59fc16f21e40398fba06c614eb6dc96b1b86d8f84a90f
    HEAD_REF master
)

file(REMOVE_RECURSE "${SOURCE_PATH}/dpdk")
file(COPY "${SPDK_DPDK_SOURCE_PATH}/" DESTINATION "${SOURCE_PATH}/dpdk")

FIND_PATH(NUMA_INCLUDE_DIR NAME numa.h
    PATHS ENV NUMA_ROOT
    HINTS "$ENV{HOME}/local/include" /opt/local/include /usr/local/include /usr/include
)
IF (NOT NUMA_INCLUDE_DIR)
    MESSAGE(FATAL_ERROR "Numa library not found.\nTry: 'sudo yum install numactl numactl-devel' (or sudo apt-get install libnuma1 libnuma-dev)")
ENDIF ()

vcpkg_cmake_configure(
    SOURCE_PATH "${CMAKE_CURRENT_LIST_DIR}"
    OPTIONS
        "-DSOURCE_PATH=${SOURCE_PATH}"
)

vcpkg_cmake_install()

FILE(INSTALL "${SOURCE_PATH}/Release/lib/" DESTINATION "${CURRENT_PACKAGES_DIR}/lib")
FILE(INSTALL "${SOURCE_PATH}/Debug/lib/" DESTINATION "${CURRENT_PACKAGES_DIR}/debug/lib")
FILE(INSTALL "${SOURCE_PATH}/include/spdk" DESTINATION "${CURRENT_PACKAGES_DIR}/include/${PORT}")
FILE(INSTALL "${SOURCE_PATH}/scripts/setup.sh" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}/scripts")
FILE(INSTALL "${SOURCE_PATH}/scripts/common.sh" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}/scripts")
FILE(INSTALL "${SOURCE_PATH}/include/spdk/pci_ids.h" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}/include/spdk")
FILE(INSTALL "${CMAKE_CURRENT_LIST_DIR}/spdkConfig.cmake" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}")
FILE(INSTALL "${CMAKE_CURRENT_LIST_DIR}/usage" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}")
FILE(INSTALL "${SOURCE_PATH}/LICENSE" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}" RENAME copyright)

FILE(INSTALL "${SOURCE_PATH}/isa-l/.libs/" DESTINATION "${CURRENT_PACKAGES_DIR}/lib")
FILE(INSTALL "${SOURCE_PATH}/isa-l-crypto/.libs/" DESTINATION "${CURRENT_PACKAGES_DIR}/lib")
FILE(INSTALL "${SOURCE_PATH}/dpdk/build/lib/" DESTINATION "${CURRENT_PACKAGES_DIR}/lib")

FILE(INSTALL "${SOURCE_PATH}/isa-l/.libs/" DESTINATION "${CURRENT_PACKAGES_DIR}/debug/lib")
FILE(INSTALL "${SOURCE_PATH}/isa-l-crypto/.libs/" DESTINATION "${CURRENT_PACKAGES_DIR}/debug/lib")
FILE(INSTALL "${SOURCE_PATH}/dpdk/build/lib/" DESTINATION "${CURRENT_PACKAGES_DIR}/debug/lib")
